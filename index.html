<!DOCTYPE html>
<html>
<head>
  <title>DAO Active Injunctions</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    html, body { margin:0; padding:0; height:100%; overflow:hidden; font-family:sans-serif; }
    #map { height:100vh; width:100vw; background:#c9f7f7; }

    /* Buttons */
    #loginBtn, #createZoneBtn { position:absolute; right:20px; padding:10px 20px; border:none; border-radius:5px; font-weight:bold; font-size:14px; cursor:pointer; z-index:2000; }
    #loginBtn { top:20px; background:#ff4444; color:white; box-shadow:0 2px 5px rgba(0,0,0,0.3); }
    #loginBtn:hover { background:#ff2222; }
    #createZoneBtn { top:60px; background:#2288ff; color:white; display:none; }
    #createZoneBtn:hover { background:#0066ff; }

    /* Sidebars */
    .sidebar {
      position: absolute;
      top:0; bottom:0; width:350px; background:#f5f5f5; padding:15px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3); overflow-y:auto;
      transition: transform 0.3s ease;
      z-index:3000;
    }
    #editSidebar { left:0; transform:translateX(-100%); }
    #infoSidebar { right:0; transform:translateX(100%); }
    .sidebar.active { transform:translateX(0); }
    .sidebar h2 { margin-top:0; }
    .sidebar button.closeBtn { position:absolute; top:10px; right:10px; background:#888; color:white; border:none; border-radius:3px; padding:2px 6px; cursor:pointer; }
    .sidebar button.closeBtn:hover { background:#555; }

    .inputGroup { margin-bottom:10px; }
    .inputGroup label { display:block; margin-bottom:2px; font-weight:bold; }
    .inputGroup input, .inputGroup textarea { width:100%; padding:5px; box-sizing:border-box; }
    .mugshotRow { display:flex; align-items:center; margin-bottom:5px; }
    .mugshotRow input { margin-right:5px; flex:1; }
    .mugshotRow button { flex:none; }

  </style>
</head>
<body>

<div id="map"></div>
<button id="loginBtn">Sign in with GTA World</button>
<button id="createZoneBtn">Create New Zone</button>

<!-- Edit Sidebar -->
<div id="editSidebar" class="sidebar">
  <button class="closeBtn" onclick="toggleSidebar('editSidebar')">X</button>
  <h2>Create / Edit Zone</h2>
  <div class="inputGroup">
    <label>Name:</label>
    <input type="text" id="zoneName">
  </div>
  <div class="inputGroup">
    <label>Color:</label>
    <input type="color" id="zoneColor" value="#0000FF">
  </div>
  <div class="inputGroup">
    <label>Additional Info:</label>
    <textarea id="zoneInfo"></textarea>
  </div>
  <div class="inputGroup" id="mugshotsContainer">
    <label>Mugshots:</label>
  </div>
  <button id="addMugshotBtn">Add Mugshot</button>
  <br><br>
  <button id="saveZoneBtn">Save Zone</button>
  <button id="deleteZoneBtn" style="display:none;">Delete Zone</button>
</div>

<!-- Info Sidebar -->
<div id="infoSidebar" class="sidebar">
  <button class="closeBtn" onclick="toggleSidebar('infoSidebar')">X</button>
  <h2 id="infoName"></h2>
  <p id="infoCreator"></p>
  <p id="infoAdditional"></p>
  <div id="infoMugshots"></div>
</div>

<script>
  // ===============================
  // MAP SETUP
  // ===============================
  const map = L.map('map', { crs:L.CRS.Simple, minZoom:0, maxZoom:5 });
  const bounds=[[0,0],[3500,3500]];
  L.imageOverlay('lsmap.jpeg', bounds).addTo(map);
  map.fitBounds(bounds).setZoom(1);

  // ===============================
  // GLOBAL VARIABLES
  // ===============================
  let zones = [];
  let currentZone=null;
  let drawing=false;
  let tempPoints=[];
  let tempPolygon=null;
  let authorized=false; // after password
  let userPassword='';

  // ===============================
  // AUTH LOGIN
  // ===============================
  const clientId="130";
  const redirectUri="https://dao-active-injunctions.onrender.com/auth/callback";
  document.getElementById('loginBtn').addEventListener('click', () => {
    const authUrl=`https://ucp.gta.world/oauth/authorize?client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&response_type=code`;
    window.location.href=authUrl;
  });

  // Check URL for GTAW username
  const params = new URLSearchParams(window.location.search);
  const username = params.get('username');
  if(username){ document.getElementById('loginBtn').style.display='none'; }

  // ===============================
  // FETCH ZONES FROM BACKEND
  // ===============================
  async function loadZones(){
    try{
      const res=await fetch('https://dao-active-injunctions.onrender.com/zones');
      zones=await res.json();
      zones.forEach(zone=>{
        zone.polygon=L.polygon(zone.points,{color:zone.color||"#0000FF",fillOpacity:0.4})
          .addTo(map)
          .bindTooltip(zone.name,{direction:"center"})
          .on('click',()=>showZoneInfo(zone));
      });
    }catch(err){ console.error(err); }
  }
  loadZones();

  // ===============================
  // SHOW INFO SIDEBAR
  // ===============================
  function showZoneInfo(zone){
    currentZone=zone;
    document.getElementById('infoName').textContent=zone.name;
    document.getElementById('infoCreator').textContent="Created by: "+zone.creator;
    document.getElementById('infoAdditional').textContent=zone.info||'';
    const mugshotsDiv=document.getElementById('infoMugshots');
    mugshotsDiv.innerHTML='';
    (zone.mugshots||[]).forEach(ms=>{
      const img=document.createElement('img');
      img.src=ms.url;
      img.width=150; img.height=150;
      img.alt=ms.label||'';
      const label=document.createElement('div');
      label.textContent=ms.label||'';
      label.style.textAlign='center';
      mugshotsDiv.appendChild(img);
      mugshotsDiv.appendChild(label);
    });
    toggleSidebar('infoSidebar',true);
  }

  // ===============================
  // TOGGLE SIDEBAR
  // ===============================
  function toggleSidebar(id,show){
    const el=document.getElementById(id);
    if(show===undefined) el.classList.toggle('active');
    else el.classList.toggle('active',show);
  }

  // ===============================
  // CREATE NEW ZONE
  // ===============================
  document.getElementById('createZoneBtn').addEventListener('click',()=>{
    if(!authorized){
      const pass=prompt("Enter DAO password to create zones:");
      if(pass!=='daopassword2026'){ alert("Wrong password"); return; }
      authorized=true; userPassword=pass;
    }
    currentZone=null;
    drawing=true; tempPoints=[];
    if(tempPolygon) map.removeLayer(tempPolygon);
    toggleSidebar('editSidebar',true);
  });

  map.on('click',e=>{
    if(!drawing) return;
    tempPoints.push([e.latlng.lat,e.latlng.lng]);
    if(tempPolygon) map.removeLayer(tempPolygon);
    tempPolygon=L.polygon(tempPoints,{color:document.getElementById('zoneColor').value,fillOpacity:0.4}).addTo(map);
  });

  // ===============================
  // EDIT SIDEBAR FUNCTIONS
  // ===============================
  const mugshotsContainer=document.getElementById('mugshotsContainer');
  document.getElementById('addMugshotBtn').addEventListener('click',()=>{
    const row=document.createElement('div'); row.className='mugshotRow';
    const urlInput=document.createElement('input'); urlInput.placeholder='Imgur URL';
    const labelInput=document.createElement('input'); labelInput.placeholder='Label';
    const removeBtn=document.createElement('button'); removeBtn.textContent='X';
    removeBtn.onclick=()=>row.remove();
    row.appendChild(urlInput); row.appendChild(labelInput); row.appendChild(removeBtn);
    mugshotsContainer.appendChild(row);
  });

  document.getElementById('saveZoneBtn').addEventListener('click',async()=>{
    const name=document.getElementById('zoneName').value;
    const color=document.getElementById('zoneColor').value;
    const info=document.getElementById('zoneInfo').value;
    const mugshots=[];
    document.querySelectorAll('.mugshotRow').forEach(row=>{
      const inputs=row.querySelectorAll('input');
      if(inputs[0].value) mugshots.push({url:inputs[0].value,label:inputs[1].value});
    });
    if(!name||tempPoints.length<3){ alert("Zone must have a name and at least 3 points"); return; }

    const payload={ name, points:tempPoints, color, info, mugshots, creator:username||'Anonymous', password:userPassword };
    try{
      const res=await fetch('https://dao-active-injunctions.onrender.com/zones',{
        method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)
      });
      const savedZone=await res.json();
      if(tempPolygon) tempPolygon.remove();
      savedZone.polygon=L.polygon(savedZone.points,{color:savedZone.color||"#0000FF",fillOpacity:0.4})
        .addTo(map)
        .bindTooltip(savedZone.name,{direction:"center"})
        .on('click',()=>showZoneInfo(savedZone));
      toggleSidebar('editSidebar',false);
      tempPoints=[]; tempPolygon=null;
    }catch(err){ console.error(err); alert("Error saving zone"); }
  });

  // ===============================
  // DELETE ZONE
  // ===============================
  document.getElementById('deleteZoneBtn').addEventListener('click',async()=>{
    if(!currentZone) return;
    try{
      const res=await fetch('https://dao-active-injunctions.onrender.com/zones/delete',{
        method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id:currentZone.id,password:userPassword})
      });
      const resp=await res.json();
      if(resp.success){
        currentZone.polygon.remove();
        toggleSidebar('editSidebar',false);
        currentZone=null;
      }else alert("Error deleting zone");
    }catch(err){ console.error(err); alert("Error deleting zone"); }
  });

</script>
</body>
</html>
