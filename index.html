<!DOCTYPE html>
<html>
<head>
  <title>DAO Active Injunctions</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    html, body { margin:0; padding:0; height:100%; overflow:hidden; }
    #map { height:100vh; width:100vw; background:#c9f7f7; }
    .leaflet-interactive:focus { outline:none; }

    /* Buttons */
    #loginBtn, #createZoneBtn {
      position:absolute; right:20px; padding:10px 20px; border:none; border-radius:5px;
      font-weight:bold; font-size:14px; cursor:pointer; z-index:2000;
    }
    #loginBtn { top:20px; background:#ff4444; color:white; box-shadow:0 2px 5px rgba(0,0,0,0.3); }
    #loginBtn:hover { background:#ff2222; }
    #createZoneBtn { top:60px; background:#2288ff; color:white; display:none; }
    #createZoneBtn:hover { background:#0066ff; }
  </style>
</head>
<body>

<div id="map"></div>
<button id="loginBtn">Sign in with GTA World</button>
<button id="createZoneBtn">Create New Zone</button>

<script>
  // ===============================
  // MAP SETUP
  // ===============================
  const imageWidth = 3500, imageHeight = 3500;
  const bounds = [[0,0],[imageHeight,imageWidth]];
  const map = L.map('map', {
    crs: L.CRS.Simple, minZoom:0, maxZoom:5, maxBounds:bounds,
    maxBoundsViscosity:1, zoomSnap:0.5, zoomDelta:0.5
  });
  L.imageOverlay('./lsmap.jpeg', bounds).addTo(map);
  map.fitBounds(bounds); map.setZoom(1);

  // CTRL+CLICK coordinates popup
  map.on('click', e => {
    if (e.originalEvent.ctrlKey) {
      const y=Math.round(e.latlng.lat), x=Math.round(e.latlng.lng);
      L.popup().setLatLng(e.latlng).setContent(`<b>Coordinates:</b><br>[ ${y}, ${x} ]`).openOn(map);
      console.log("Coordinate:", `[${y}, ${x}]`);
    }
  });

  // ===============================
  // AUTH LOGIN
  // ===============================
  const clientId = "130"; 
  const redirectUri = "https://dao-active-injunctions.onrender.com/auth/callback";
  document.getElementById('loginBtn').addEventListener('click', () => {
    const authUrl = `https://ucp.gta.world/oauth/authorize?client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&response_type=code`;
    window.location.href = authUrl;
  });

  // ===============================
  // Parse URL for logged-in user
  // ===============================
  const params = new URLSearchParams(window.location.search);
  const username = params.get('username');
  const faction = params.get('faction');

  if (username) {
    console.log(`Logged in as ${username}, faction: ${faction}`);
    document.getElementById('loginBtn').style.display = 'none';

    if (faction === "District Attorney's Office") {
      document.getElementById('createZoneBtn').style.display = 'block';
    }
  }

  // ===============================
  // LOAD EXISTING ZONES
  // ===============================
  fetch('/zones').then(res => res.json()).then(data => {
    data.forEach(zone => {
      L.polygon(zone.points, { color:"#0000FF", fillOpacity:0.4 })
       .addTo(map).bindTooltip(zone.name, {direction:"center"});
    });
  });

  // ===============================
  // CREATE NEW ZONE
  // ===============================
  let drawingZone=false, tempPoints=[], tempPolygon=null;

  const createBtn = document.getElementById('createZoneBtn');
  createBtn.addEventListener('click', () => {
    drawingZone = true; tempPoints=[]; alert("Click points for the zone. Press 'S' to save.");
  });

  map.on('click', e => {
    if (!drawingZone) return;
    tempPoints.push([e.latlng.lat, e.latlng.lng]);
    if(tempPolygon) map.removeLayer(tempPolygon);
    tempPolygon = L.polygon(tempPoints, {color:"#0000FF", fillOpacity:0.4}).addTo(map);
  });

  document.addEventListener('keydown', e => {
    if (drawingZone && e.key.toLowerCase() === 's') {
      const zoneName = prompt("Enter zone name:");
      if (!zoneName) return alert("Zone must have a name!");
      fetch('/zones', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({name:zoneName, points:tempPoints})
      }).then(res=>res.json()).then(data=>{
        alert("Zone saved!");
        drawingZone=false; tempPoints=[]; tempPolygon=null;
        L.polygon(data.points, {color:"#0000FF", fillOpacity:0.4})
          .addTo(map).bindTooltip(data.name, {direction:"center"});
      });
    }
  });
</script>

</body>
</html>
