<!DOCTYPE html>
<html>
<head>
  <title>DAO Active Injunctions</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    html, body { margin:0; padding:0; height:100%; overflow:hidden; font-family:Arial,sans-serif; }
    #map { height:100vh; width:100vw; background:#c9f7f7; }
    .leaflet-interactive:focus { outline:none; }

    button { cursor:pointer; border:none; border-radius:5px; font-weight:bold; font-size:14px; padding:10px 20px; }

    #loginBtn { position:absolute; top:20px; right:20px; z-index:2000; background:#ff4444; color:white; box-shadow:0 2px 5px rgba(0,0,0,0.3); }
    #loginBtn:hover { background:#ff2222; }

    #createZoneBtn { position:absolute; top:60px; right:20px; z-index:2000; background:#2288ff; color:white; display:none; box-shadow:0 2px 5px rgba(0,0,0,0.3); }
    #createZoneBtn:hover { background:#0066ff; }

    /* Sidebars */
    .sidebar { position:absolute; top:0; width:300px; height:100%; background:white; box-shadow:0 0 10px rgba(0,0,0,0.3); transform:translateX(100%); transition: transform 0.3s ease; padding:10px; overflow-y:auto; z-index:2100; }
    .sidebar.show { transform:translateX(0); }
    .sidebar h2 { margin-top:0; }
    .closeBtn { position:absolute; top:5px; right:10px; cursor:pointer; font-size:18px; font-weight:bold; }

    .zone-info img { width:150px; height:150px; object-fit:cover; margin-bottom:5px; display:block; }
  </style>
</head>
<body>

<div id="map"></div>
<button id="loginBtn">Sign in with GTA World</button>
<button id="createZoneBtn">Create New Zone</button>

<!-- Sidebars -->
<div id="editSidebar" class="sidebar">
  <span class="closeBtn" onclick="editSidebar.classList.remove('show')">X</span>
  <h2>Edit Zone</h2>
  <label>Name: <input type="text" id="zoneName"></label><br>
  <label>Color: <input type="color" id="zoneColor" value="#0000FF"></label><br>
  <label>Additional Info:<br><textarea id="zoneInfo" rows="4" style="width:100%"></textarea></label><br>
  <h3>Mugshots</h3>
  <div id="mugshotsContainer"></div>
  <button id="addMugshotBtn">Add Mugshot</button><br><br>
  <button id="saveZoneBtn">Save Zone</button>
  <button id="deleteZoneBtn" style="background:red;color:white;">Delete Zone</button>
</div>

<div id="infoSidebar" class="sidebar">
  <span class="closeBtn" onclick="infoSidebar.classList.remove('show')">X</span>
  <h2>Zone Info</h2>
  <div id="infoContent"></div>
</div>

<script>
  const map = L.map('map', { crs:L.CRS.Simple, minZoom:0, maxZoom:5 }).setView([1750,1750],1);
  L.imageOverlay('lsmap.jpeg', [[0,0],[3500,3500]]).addTo(map);

  let zones = [];
  let editingZone = null;
  const DA_PASSWORD = 'daopassword2026';
  let authorized = false;

  const loginBtn = document.getElementById('loginBtn');
  const createZoneBtn = document.getElementById('createZoneBtn');
  const editSidebar = document.getElementById('editSidebar');
  const infoSidebar = document.getElementById('infoSidebar');

  // ===============================
  // GTAW Login
  // ===============================
  const clientId = "130";
  const redirectUri = "https://dao-active-injunctions.onrender.com/auth/callback";

  loginBtn.addEventListener('click', () => {
    window.location.href = `https://ucp.gta.world/oauth/authorize?client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&response_type=code`;
  });

  // ===============================
  // Parse username from URL
  // ===============================
  const params = new URLSearchParams(window.location.search);
  const username = params.get('username');
  if (username) {
    loginBtn.style.display='none';
    createZoneBtn.style.display='block';
  }

  // ===============================
  // Load zones from backend
  // ===============================
  async function loadZones() {
    const res = await fetch('/zones');
    zones = await res.json();
    zones.forEach(drawZone);
  }

  function drawZone(zone) {
    const polygon = L.polygon(zone.points, {color:zone.color, fillOpacity:0.4}).addTo(map);
    polygon.on('click', () => showInfoSidebar(zone));
    polygon.zoneData = zone;
  }

  function showInfoSidebar(zone) {
    const c = document.getElementById('infoContent');
    c.innerHTML = `<strong>${zone.name}</strong><br>${zone.additionalInfo}<br>Mugshots:<br>`;
    zone.mugshots.forEach(m => c.innerHTML += `<img src="${m.link}" alt="${m.label}"><small>${m.label}</small><br>`);
    infoSidebar.classList.add('show');
  }

  // ===============================
  // Create Zone Button
  // ===============================
  let creatingZone = false;
  let newPoints = [];
  createZoneBtn.addEventListener('click', () => {
    if (!authorized) {
      const pw = prompt("Enter DAO password:");
      if (pw !== DA_PASSWORD) return alert("Incorrect password!");
      authorized = true;
    }
    creatingZone = true;
    newPoints = [];
    alert("Click points on the map to create the new zone. Then edit details in the sidebar.");
    editSidebar.classList.add('show');
  });

  // Add points
  map.on('click', e => {
    if (creatingZone && authorized) {
      newPoints.push([e.latlng.lat,e.latlng.lng]);
      if (editingZone) map.removeLayer(editingZone.leafletPolygon);
      editingZone = {points:newPoints,color:'#0000FF'};
      editingZone.leafletPolygon = L.polygon(newPoints,{color:editingZone.color,fillOpacity:0.4}).addTo(map);
    }
  });

  // Save Zone
  document.getElementById('saveZoneBtn').addEventListener('click', async () => {
    if (!editingZone || newPoints.length<3) return alert("Add at least 3 points!");
    const zoneData = {
      name: document.getElementById('zoneName').value || 'Untitled Zone',
      color: document.getElementById('zoneColor').value,
      additionalInfo: document.getElementById('zoneInfo').value,
      points:newPoints,
      creator: username || 'Anonymous',
      mugshots: [] // collect mugshots if needed
    };
    const res = await fetch('/zones',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(zoneData)});
    const saved = await res.json();
    drawZone(saved);
    creatingZone=false;
    newPoints=[];
    editSidebar.classList.remove('show');
    alert("Zone saved!");
  });

  // Delete Zone
  document.getElementById('deleteZoneBtn').addEventListener('click', async () => {
    if (!editingZone || !editingZone.id) return;
    await fetch(`/zones/${editingZone.id}`,{method:'DELETE'});
    map.eachLayer(layer => { if(layer.zoneData && layer.zoneData.id === editingZone.id) map.removeLayer(layer); });
    editSidebar.classList.remove('show');
    alert("Zone deleted!");
  });

  loadZones();
</script>
</body>
</html>
