<!DOCTYPE html>
<html>
<head>
  <title>DAO Active Injunctions</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    html, body { margin:0; padding:0; height:100%; overflow:hidden; font-family:Arial,sans-serif; }
    #map { height:100vh; width:100vw; background:#c9f7f7; }
    .leaflet-interactive:focus { outline:none; }

    /* Buttons */
    #loginBtn, #createZoneBtn {
      position:absolute; right:20px; padding:10px 20px; border:none; border-radius:5px;
      font-weight:bold; font-size:14px; cursor:pointer; z-index:2000;
      transition: all 0.2s ease;
    }
    #loginBtn { top:20px; background:#ff4444; color:white; box-shadow:0 2px 5px rgba(0,0,0,0.3); }
    #loginBtn:hover { background:#ff2222; }
    #createZoneBtn { top:60px; background:#2288ff; color:white; display:none; }
    #createZoneBtn:hover { background:#0066ff; }

    /* Right sidebar: zone creation */
    #sidebarCreate {
      position: absolute; top:0; right:-360px; width:360px; height:100%; background:#fff; box-shadow:-2px 0 10px rgba(0,0,0,0.3);
      padding:20px; overflow-y:auto; transition: right 0.3s ease; z-index:2500;
    }
    #sidebarCreate.active { right:0; }

    /* Left sidebar: info display */
    #sidebarInfo {
      position: absolute; top:0; left:-360px; width:360px; height:100%; background:#f9f9f9; box-shadow:2px 0 10px rgba(0,0,0,0.3);
      padding:20px; overflow-y:auto; transition: left 0.3s ease; z-index:2500;
    }
    #sidebarInfo.active { left:0; }

    .closeBtn { position:absolute; top:10px; right:10px; font-weight:bold; cursor:pointer; font-size:18px; color:#555; }
    .closeBtn:hover { color:#000; }

    #sidebarCreate h2, #sidebarInfo h2 { margin-top:0; font-size:18px; }
    #sidebarCreate label, #sidebarInfo label { display:block; margin-top:10px; font-weight:bold; }
    #sidebarCreate input, #sidebarCreate textarea { width:100%; padding:5px; margin-top:5px; box-sizing:border-box; }
    #sidebarInfo textarea { width:100%; box-sizing:border-box; padding:5px; }
    #sidebarInfo img.mugshot { width:150px; height:150px; object-fit:cover; margin-top:5px; display:block; }
    #sidebarCreate button, #sidebarInfo button { margin-top:10px; padding:8px 12px; cursor:pointer; }
  </style>
</head>
<body>

<div id="map"></div>
<button id="loginBtn">Sign in with GTA World</button>
<button id="createZoneBtn">Create New Zone</button>

<div id="sidebarCreate"><span class="closeBtn" onclick="closeSidebar('create')">&times;</span></div>
<div id="sidebarInfo"><span class="closeBtn" onclick="closeSidebar('info')">&times;</span></div>

<script>
  const map = L.map('map',{
    crs:L.CRS.Simple,minZoom:0,maxZoom:5,maxBounds:[[0,0],[3500,3500]],
    maxBoundsViscosity:1,zoomSnap:0.5,zoomDelta:0.5
  });
  L.imageOverlay('lsmap.jpeg',[[0,0],[3500,3500]]).addTo(map);
  map.fitBounds([[0,0],[3500,3500]]);

  const clientId = "130";
  const redirectUri = "https://dao-active-injunctions.onrender.com/auth/callback";
  const params = new URLSearchParams(window.location.search);
  const username = params.get('username');
  const passwordForEdit = "daopassword2026";
  let daoAuthenticated=false;

  const sidebarCreate = document.getElementById('sidebarCreate');
  const sidebarInfo = document.getElementById('sidebarInfo');
  let editingZone=null,newZonePoints=[],tempPolygon=null;

  function closeSidebar(which){
    if(which==='create') sidebarCreate.classList.remove("active");
    if(which==='info') sidebarInfo.classList.remove("active");
  }

  if(username){
    document.getElementById('loginBtn').style.display='none';
    document.getElementById('createZoneBtn').style.display='block';
  }

  document.getElementById('loginBtn').onclick=()=>{window.location.href=`https://ucp.gta.world/oauth/authorize?client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&response_type=code`;};

  // ================= CREATE ZONE =================
  document.getElementById('createZoneBtn').onclick=()=>{
    if(!daoAuthenticated){
      const entered=prompt("Enter DAO password to create zone:");
      if(entered!==passwordForEdit) return alert("Incorrect password.");
      daoAuthenticated=true;
    }
    editingZone={id:Date.now(),points:[],creator:username,color:"#0000FF",info:"",mugshots:[],name:""};
    newZonePoints=[]; map.on('click', addPointForNewZone);
    showCreateSidebar(editingZone);
    alert("Click on map to add points for the new zone.");
  };

  function addPointForNewZone(e){
    newZonePoints.push([e.latlng.lat,e.latlng.lng]);
    if(tempPolygon) map.removeLayer(tempPolygon);
    tempPolygon=L.polygon(newZonePoints,{color:editingZone.color,fillOpacity:0.4}).addTo(map);
    editingZone.points=newZonePoints;
    showCreateSidebar(editingZone);
  }

  function showCreateSidebar(zone){
    sidebarCreate.innerHTML=`<span class="closeBtn" onclick="closeSidebar('create')">&times;</span>
      <h2>Editing Zone</h2>
      <label>Name:</label><input type="text" id="zoneName" value="${zone.name}">
      <label>Color:</label><input type="color" id="zoneColor" value="${zone.color}">
      <label>Info:</label><textarea id="zoneInfo">${zone.info}</textarea>
      <label>Mugshots (comma-separated imgur links):</label><textarea id="zoneMugshots">${zone.mugshots.join(",")}</textarea>
      <button id="saveZoneBtn">Save Zone</button>
      <button id="deleteZoneBtn">Delete Zone</button>`;
    sidebarCreate.classList.add("active");

    document.getElementById('zoneName').oninput=e=>{zone.name=e.target.value;updateTempPolygon();}
    document.getElementById('zoneColor').oninput=e=>{zone.color=e.target.value;updateTempPolygon();}
    document.getElementById('zoneInfo').oninput=e=>{zone.info=e.target.value;}
    document.getElementById('zoneMugshots').oninput=e=>{zone.mugshots=e.target.value.split(",");}
    document.getElementById('saveZoneBtn').onclick=saveZone;
    document.getElementById('deleteZoneBtn').onclick=deleteZone;
  }

  function updateTempPolygon(){
    if(tempPolygon) map.removeLayer(tempPolygon);
    tempPolygon=L.polygon(newZonePoints,{color:editingZone.color,fillOpacity:0.4}).addTo(map);
  }

  async function saveZone(){
    try{
      const res=await fetch('/zones',{
        method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({...editin
