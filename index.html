<!DOCTYPE html>
<html>
<head>
  <title>DAO Active Injunctions</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    html, body { margin:0; padding:0; height:100%; overflow:hidden; font-family:Arial,sans-serif; }
    #map { height:100vh; width:100vw; background:#c9f7f7; }
    .leaflet-interactive:focus { outline:none; }

    /* Buttons */
    #loginBtn, #createZoneBtn {
      position:absolute; right:20px; padding:10px 20px; border:none; border-radius:12px;
      font-weight:bold; font-size:14px; cursor:pointer; z-index:2000; transition: all 0.2s ease;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    #loginBtn { top:20px; background:#ff4444; color:white; }
    #loginBtn:hover { background:#ff2222; }
    #createZoneBtn { top:60px; background:#2288ff; color:white; display:none; }
    #createZoneBtn:hover { background:#0066ff; }

    /* Sidebars */
    #sidebarCreate, #sidebarInfo {
      position:absolute; top:0; width:380px; height:100%; background:#fff; box-shadow:2px 0 12px rgba(0,0,0,0.3);
      padding:20px; overflow-y:auto; z-index:2500; border-radius:0 12px 12px 0; transition: all 0.3s ease;
    }
    #sidebarCreate { right:-400px; }
    #sidebarCreate.active { right:0; }
    #sidebarInfo { left:-400px; background:#f9f9f9; border-radius:12px 0 0 12px; }
    #sidebarInfo.active { left:0; }

    .closeBtn { position:absolute; top:10px; right:10px; font-weight:bold; cursor:pointer; font-size:18px; color:#555; }
    .closeBtn:hover { color:#000; }

    h2 { margin-top:0; font-size:18px; }
    label { display:block; margin-top:10px; font-weight:bold; }
    input, textarea { width:100%; padding:6px; margin-top:5px; box-sizing:border-box; border-radius:6px; border:1px solid #ccc; }
    textarea { resize:vertical; }
    .mugshot-container { display:flex; align-items:center; margin-top:5px; }
    .mugshot-container input { flex:1; margin-left:5px; padding:4px; border-radius:6px; border:1px solid #ccc; }
    img.mugshot { width:150px; height:150px; object-fit:cover; margin-top:5px; display:block; border-radius:8px; }

    button { margin-top:10px; padding:8px 12px; cursor:pointer; border:none; border-radius:8px; font-weight:bold; transition:0.2s; }
    button:hover { opacity:0.85; }
    #addMugshotBtn { background:#17a2b8; color:white; }
    #saveZoneBtn { background:#28a745; color:white; }
    #deleteZoneBtn { background:#dc3545; color:white; }
    #undoPointBtn { background:#ffc107; color:white; }
    #cancelZoneBtn { background:#6c757d; color:white; }
    #deleteByNameBtn { background:#b22222; color:white; }
  </style>
</head>
<body>

<div id="map"></div>
<button id="loginBtn">Sign in with GTA World</button>
<button id="createZoneBtn">Create New Zone</button>

<div id="sidebarCreate"><span class="closeBtn" onclick="closeSidebar('create')">&times;</span></div>
<div id="sidebarInfo"><span class="closeBtn" onclick="closeSidebar('info')">&times;</span></div>

<script>
const map = L.map('map',{
  crs:L.CRS.Simple,minZoom:0,maxZoom:5,maxBounds:[[0,0],[3500,3500]],
  maxBoundsViscosity:1,zoomSnap:0.5,zoomDelta:0.5
});
L.imageOverlay('lsmap.jpeg',[[0,0],[3500,3500]]).addTo(map);
map.fitBounds([[0,0],[3500,3500]]);

const clientId="130";
const redirectUri="https://dao-active-injunctions.onrender.com/auth/callback";
const githubAPI="https://dao-active-injunctions.onrender.com";

// ================= SECURE USERNAME FETCH =================
const params = new URLSearchParams(window.location.search);
const sessionToken = params.get('token');
let username = null;
let daoAuthenticated = false;

async function fetchUsername() {
  if (!sessionToken) return;
  try {
    const res = await fetch(`${githubAPI}/session/${sessionToken}`);
    const data = await res.json();
    if (data.username) {
      username = data.username;
      document.getElementById('loginBtn').style.display='none';
      document.getElementById('createZoneBtn').style.display='block';
    } else alert("Invalid session token");
  } catch (err) { console.error(err); }
}
fetchUsername();

const sidebarCreate=document.getElementById('sidebarCreate');
const sidebarInfo=document.getElementById('sidebarInfo');
let editingZone=null,newZonePoints=[],tempPolygon=null;
let polygonLayers = new Map();

function closeSidebar(which){
  if(which==='create'){
    sidebarCreate.classList.remove("active");
    if(tempPolygon){ map.removeLayer(tempPolygon); tempPolygon=null; }
    newZonePoints=[];
    editingZone=null;
    map.off('click', addPointForNewZone);
  }
  if(which==='info') sidebarInfo.classList.remove("active");
}

document.getElementById('loginBtn').onclick=()=>{window.location.href=`https://ucp.gta.world/oauth/authorize?client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&response_type=code`;};

// ================= CREATE ZONE =================
document.getElementById('createZoneBtn').onclick=()=>{
  if(!username) return alert("You must be logged in to create zones");

  editingZone={id:Date.now(),points:[],creator:username,color:"#0000FF",info:"",mugshots:[],name:""};
  newZonePoints=[];
  showCreateSidebar(editingZone);
  map.on('click', addPointForNewZone);
};

function addPointForNewZone(e){
  newZonePoints.push([e.latlng.lat,e.latlng.lng]);
  updateTempPolygon();
  editingZone.points = newZonePoints;
}

// ================= SHOW CREATE SIDEBAR =================
function showCreateSidebar(zone){
  sidebarCreate.innerHTML=`<span class="closeBtn" onclick="closeSidebar('create')">&times;</span>
    <h2>Editing Zone</h2>
    <label>Name:</label><input type="text" id="zoneName" value="${zone.name}">
    <label>Color:</label><input type="color" id="zoneColor" value="${zone.color}">
    <label>Info:</label><textarea id="zoneInfo">${zone.info}</textarea>
    <label>Mugshots:</label><div id="mugshotList"></div>
    <button id="addMugshotBtn">Add Mugshot</button>
    <button id="undoPointBtn">Undo Last Point</button>
    <button id="cancelZoneBtn">Cancel Zone</button>
    <button id="saveZoneBtn">Save Zone</button>
    <button id="deleteZoneBtn">Delete Zone</button>
    <label>Delete Zone by Name:</label>
    <input type="text" id="deleteByNameInput" placeholder="Enter zone name to delete">
    <button id="deleteByNameBtn">Delete by Name</button>`;

  sidebarCreate.classList.add("active");

  function addMugshotInput(url="",label=""){
    const container=document.createElement("div");
    container.className="mugshot-container";
    container.innerHTML=`<input type="text" placeholder="Imgur URL" value="${url}">
                         <input type="text" placeholder="Label" value="${label}">`;
    container.querySelectorAll("input")[0].oninput=e=>container.dataset.url=e.target.value;
    container.querySelectorAll("input")[1].oninput=e=>container.dataset.label=e.target.value;
    document.getElementById('mugshotList').appendChild(container);
  }

  zone.mugshots.forEach(m=>addMugshotInput(m.url,m.label));
  document.getElementById('addMugshotBtn').onclick=()=>addMugshotInput();

  document.getElementById('undoPointBtn').onclick=()=>{
    if(newZonePoints.length>0) newZonePoints.pop();
    updateTempPolygon();
    editingZone.points = newZonePoints;
  };

  document.getElementById('cancelZoneBtn').onclick=()=>closeSidebar('create');

  document.getElementById('zoneName').oninput=e=>{zone.name=e.target.value; updateTempPolygon();}
  document.getElementById('zoneColor').oninput=e=>{zone.color=e.target.value; updateTempPolygon();}
  document.getElementById('zoneInfo').oninput=e=>{zone.info=e.target.value;}
  document.getElementById('saveZoneBtn').onclick=saveZone;
  document.getElementById('deleteZoneBtn').onclick=deleteZone;

  document.getElementById('deleteByNameBtn').onclick = async () => {
    const name = document.getElementById('deleteByNameInput').value.trim();
    if(!name) return alert("Enter a zone name!");
    if(!confirm(`Are you sure you want to delete "${name}"?`)) return;

    try{
      const res = await fetch(`${githubAPI}/zones/deleteByName`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body:JSON.stringify({ token: sessionToken, name })
      });
      const data = await res.json();
      if(data.success){
        alert(`Zone "${name}" deleted!`);
        loadZones();
        closeSidebar('create');
      } else alert(data.error || "Error deleting zone");
    }catch(err){alert("Error deleting zone"); console.error(err);}
  };
}

function updateTempPolygon(){
  if(tempPolygon) map.removeLayer(tempPolygon);
  if(newZonePoints.length>0) tempPolygon=L.polygon(newZonePoints,{color:editingZone.color,fillOpacity:0.4}).addTo(map);
}

// ================= SAVE / DELETE =================
async function saveZone(){
  const mugshots=[];
  document.querySelectorAll("#mugshotList .mugshot-container").forEach(c=>{
    if(c.querySelectorAll("input")[0].value) mugshots.push({url:c.querySelectorAll("input")[0].value,label:c.querySelectorAll("input")[1].value});
  });
  editingZone.mugshots=mugshots;
  try{
    const res=await fetch(`${githubAPI}/zones`,{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({...editingZone,token: sessionToken, creator:username})
    });
    const data=await res.json();
    alert("Zone saved!");
    if(tempPolygon){ map.removeLayer(tempPolygon); tempPolygon=null; }
    newZonePoints=[]; editingZone=null;
    map.off('click', addPointForNewZone);
    loadZones();
    closeSidebar('create');
  }catch(err){alert("Error saving zone"); console.error(err);}
}

async function deleteZone(){
  try{
    await fetch(`${githubAPI}/zones/${editingZone.id}`,{
      method:'DELETE',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ token: sessionToken })
    });
    alert("Zone deleted!");
    if(tempPolygon){ map.removeLayer(tempPolygon); tempPolygon=null; }
    newZonePoints=[]; editingZone=null;
    map.off('click', addPointForNewZone);
    loadZones();
    closeSidebar('create');
  }catch(err){alert("Error deleting zone"); console.error(err);}
}

// ================= INFO SIDEBAR =================
function showInfoSidebar(zone){
  sidebarInfo.innerHTML=`<span class="closeBtn" onclick="closeSidebar('info')">&times;</span>
    <h2>${zone.name}</h2>
    <label>Info:</label><textarea readonly>${zone.info}</textarea>
    <label>Created by:</label><p>${zone.creator}</p>
    ${zone.mugshots.map(m=>`<div><img class="mugshot" src="${m.url}"><p>${m.label}</p></div>`).join("")}`;
  sidebarInfo.classList.add("active");
}

// ================= LOAD ZONES =================
async function loadZones(){
  try{
    const res=await fetch(`${githubAPI}/zones`);
    const data=await res.json();
    polygonLayers.forEach(layer=>{ if(layer) map.removeLayer(layer); });
    polygonLayers.clear();

    data.forEach(zone=>{
      const poly = L.polygon(zone.points,{color:zone.color,fillOpacity:0.4})
        .addTo(map)
        .bindTooltip(zone.name,{direction:"center"})
        .on('click',()=>{
          showInfoSidebar(zone);
          if(username){ // Only authenticated users
            editingZone = {...zone};
            showCreateSidebar(editingZone);
            newZonePoints = [...zone.points];
            tempPolygon=L.polygon(newZonePoints,{color:editingZone.color,fillOpacity:0.4}).addTo(map);
          }
        });
      polygonLayers.set(zone.id, poly);
    });
  }catch(err){console.error(err);}
}

loadZones();
</script>

<!-- Ko-fi floating widget -->
<script src="https://storage.ko-fi.com/cdn/scripts/overlay-widget.js"></script>
<script>
  kofiWidgetOverlay.draw('vexiousmaximus', {
    'type': 'floating-chat',
    'floating-chat.donateButton.text': 'Give me cheese',
    'floating-chat.donateButton.background-color': '#d9534f',
    'floating-chat.donateButton.text-color': '#fff'
  });
</script>

</body>
</html>
