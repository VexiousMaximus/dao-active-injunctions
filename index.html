<!DOCTYPE html>
<html>
<head>
  <title>DAO Active Injunctions</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    html, body { margin:0; padding:0; height:100%; overflow:hidden; font-family:sans-serif; }
    #map { height:100vh; width:100vw; background:#c9f7f7; }
    .leaflet-interactive:focus { outline:none; }

    /* Buttons */
    #createZoneBtn {
      position:absolute; top:20px; right:20px; padding:10px 20px;
      border:none; border-radius:5px; font-weight:bold; font-size:14px;
      cursor:pointer; z-index:2000; background:#2288ff; color:white;
      box-shadow:0 2px 5px rgba(0,0,0,0.3);
    }
    #createZoneBtn:hover { background:#0066ff; }

    /* Sidebar */
    #sidebar {
      position:fixed; top:0; right:-350px; width:350px; height:100%; background:white;
      box-shadow:-2px 0 10px rgba(0,0,0,0.3); padding:20px; overflow-y:auto;
      transition:right 0.3s ease;
      z-index:3000;
    }
    #sidebar.visible { right:0; }

    #sidebar h2 { margin-top:0; }

    #sidebar input, #sidebar textarea { width:100%; margin-bottom:10px; padding:5px; }
    #sidebar label { font-weight:bold; display:block; margin-top:10px; }

    #saveZoneBtn, #deleteZoneBtn { width:100%; padding:10px; margin-top:5px; font-weight:bold; cursor:pointer; border:none; border-radius:5px; }
    #saveZoneBtn { background:#2288ff; color:white; }
    #saveZoneBtn:hover { background:#0066ff; }
    #deleteZoneBtn { background:#ff4444; color:white; }
    #deleteZoneBtn:hover { background:#cc0000; }

    /* Info-only sidebar for public */
    #infoSidebar img { width:150px; height:150px; object-fit:cover; margin-bottom:5px; border-radius:5px; }
  </style>
</head>
<body>

<div id="map"></div>
<button id="createZoneBtn">Create New Zone</button>

<div id="sidebar">
  <h2>Create/Edit Zone</h2>
  <label>Zone Name</label>
  <input type="text" id="zoneName">
  <label>Color</label>
  <input type="color" id="zoneColor" value="#0000FF">
  <label>Additional Info</label>
  <textarea id="zoneInfo"></textarea>
  <label>Mugshots (Imgur URLs, comma separated)</label>
  <textarea id="zoneMugshots"></textarea>
  <label>Password</label>
  <input type="password" id="zonePassword">
  <button id="saveZoneBtn">Save Zone</button>
  <button id="deleteZoneBtn">Delete Zone</button>
</div>

<div id="infoSidebar" style="display:none; position:fixed; top:0; right:-350px; width:350px; height:100%; background:white; box-shadow:-2px 0 10px rgba(0,0,0,0.3); padding:20px; overflow-y:auto; transition:right 0.3s ease; z-index:3000;">
  <h2 id="infoName"></h2>
  <p id="infoText"></p>
  <div id="infoMugshots"></div>
</div>

<script>
const map = L.map('map', {
  crs: L.CRS.Simple,
  minZoom:0, maxZoom:5,
  zoomSnap:0.5, zoomDelta:0.5
});
const bounds = [[0,0],[3500,3500]];
L.imageOverlay('lsmap.jpeg', bounds).addTo(map);
map.fitBounds(bounds);
map.setZoom(1);

let zones = [];
let editingZone = null;
let newZonePoints = [];
let tempPolygon = null;

const sidebar = document.getElementById('sidebar');
const infoSidebar = document.getElementById('infoSidebar');
const createBtn = document.getElementById('createZoneBtn');
const saveBtn = document.getElementById('saveZoneBtn');
const deleteBtn = document.getElementById('deleteZoneBtn');

const API_URL = "https://dao-active-injunctions.onrender.com";

// ===== Load zones =====
async function loadZones() {
  zones.forEach(z => z.leafletPolygon && map.removeLayer(z.leafletPolygon));
  const data = await fetch(`${API_URL}/zones`).then(r=>r.json());
  zones = data.map(z=>{
    z.leafletPolygon = L.polygon(z.points, { color:z.color, fillOpacity:0.4 }).addTo(map)
      .on('click', () => showInfoSidebar(z));
    return z;
  });
}
loadZones();

// ===== Show info sidebar for public =====
function showInfoSidebar(zone) {
  infoSidebar.style.display='block';
  infoSidebar.classList.add('visible');
  document.getElementById('infoName').innerText = zone.name;
  document.getElementById('infoText').innerText = zone.info;
  const mugDiv = document.getElementById('infoMugshots');
  mugDiv.innerHTML = '';
  (zone.mugshots||[]).forEach(url=>{
    const img = document.createElement('img');
    img.src = url;
    mugDiv.appendChild(img);
  });
}

// ===== Create new zone =====
createBtn.addEventListener('click', () => {
  editingZone = null;
  newZonePoints = [];
  if (!prompt("Enter DAO password:") === "daopassword2026") return alert("Wrong password!");
  sidebar.classList.add('visible');
});

// ===== Add points =====
map.on('click', e => {
  if (!sidebar.classList.contains('visible')) return;
  newZonePoints.push([e.latlng.lat,e.latlng.lng]);
  if(tempPolygon) map.removeLayer(tempPolygon);
  tempPolygon = L.polygon(newZonePoints, {color:"#0000FF", fillOpacity:0.4}).addTo(map);
});

// ===== Save zone =====
saveBtn.addEventListener('click', async () => {
  const name = document.getElementById('zoneName').value;
  const color = document.getElementById('zoneColor').value;
  const info = document.getElementById('zoneInfo').value;
  const mugshots = document.getElementById('zoneMugshots').value.split(',').map(s=>s.trim()).filter(Boolean);
  const password = document.getElementById('zonePassword').value;
  if (!name || newZonePoints.length<3) return alert("Name & at least 3 points required");
  const res = await fetch(`${API_URL}/zones`, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({name, points:newZonePoints, color, info, mugshots, password})
  });
  const data = await res.json();
  if(res.ok){
    sidebar.classList.remove('visible');
    tempPolygon && map.removeLayer(tempPolygon);
    loadZones();
  } else alert(data.error);
});

// ===== Delete zone =====
deleteBtn.addEventListener('click', async ()=>{
  if(!editingZone) return;
  const password = document.getElementById('zonePassword').value;
  const res = await fetch(`${API_URL}/zones/${editingZone.id}`, {
    method:'DELETE',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({password})
  });
  const data = await res.json();
  if(res.ok){
    sidebar.classList.remove('visible');
    tempPolygon && map.removeLayer(tempPolygon);
    loadZones();
  } else alert(data.error);
});

</script>
</body>
</html>
