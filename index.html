<!DOCTYPE html>
<html>
<head>
  <title>DAO Active Injunctions</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    html, body { margin:0; padding:0; height:100%; overflow:hidden; font-family: sans-serif; }
    #map { height:100vh; width:100vw; background:#c9f7f7; }

    .leaflet-interactive:focus { outline:none; }

    /* Buttons */
    #loginBtn, #createZoneBtn { position:absolute; right:20px; padding:10px 20px; border:none; border-radius:5px; font-weight:bold; font-size:14px; cursor:pointer; z-index:2000; }
    #loginBtn { top:20px; background:#ff4444; color:white; box-shadow:0 2px 5px rgba(0,0,0,0.3); }
    #loginBtn:hover { background:#ff2222; }
    #createZoneBtn { top:60px; background:#2288ff; color:white; display:none; }
    #createZoneBtn:hover { background:#0066ff; }

    /* Sidebar */
    #editSidebar, #infoSidebar {
      position: absolute;
      top: 0; 
      width: 300px;
      height: 100%;
      background: white;
      box-shadow: 0 0 15px rgba(0,0,0,0.3);
      padding: 15px;
      overflow-y: auto;
      transition: transform 0.3s ease;
      z-index: 2000;
    }
    #editSidebar { right: 0; transform: translateX(100%); }
    #infoSidebar { left: 0; transform: translateX(-100%); }
    #editSidebar.active { transform: translateX(0); }
    #infoSidebar.active { transform: translateX(0); }

    .closeBtn { position:absolute; top:5px; right:5px; cursor:pointer; font-size:18px; font-weight:bold; }
    input, textarea, select { width:100%; margin-bottom:10px; padding:5px; }
    button.sidebarBtn { width: 100%; padding:10px; margin-top:5px; }
  </style>
</head>
<body>

<div id="map"></div>
<button id="loginBtn">Sign in with GTA World</button>
<button id="createZoneBtn">Create New Zone</button>

<!-- Edit Sidebar -->
<div id="editSidebar">
  <span class="closeBtn" id="editClose">&times;</span>
  <h3>Edit Zone</h3>
  <input type="text" id="zoneName" placeholder="Zone Name">
  <input type="color" id="zoneColor" value="#0000FF">
  <textarea id="zoneInfo" placeholder="Additional Info"></textarea>
  <textarea id="zoneMugshots" placeholder="Imgur links (one per line, optional: format https://i.imgur.com/xxx.jpg:Label)"></textarea>
  <button class="sidebarBtn" id="saveZoneBtn">Save Zone</button>
  <button class="sidebarBtn" id="deleteZoneBtn">Delete Zone</button>
</div>

<!-- Info Sidebar -->
<div id="infoSidebar">
  <span class="closeBtn" id="infoClose">&times;</span>
  <h3 id="infoName"></h3>
  <p id="infoText"></p>
  <div id="infoMugshots"></div>
</div>

<script>
const imageWidth = 3500, imageHeight = 3500;
const bounds = [[0,0],[imageHeight,imageWidth]];
const map = L.map('map', {
  crs: L.CRS.Simple, minZoom:0, maxZoom:5, maxBounds:bounds,
  maxBoundsViscosity:1, zoomSnap:0.5, zoomDelta:0.5
});
L.imageOverlay('lsmap.jpeg', bounds).addTo(map);
map.fitBounds(bounds); map.setZoom(1);

let drawingZone=false, tempPoints=[], tempPolygon=null;
let selectedZone=null;
let daoAuthorized=false;

// -------------------------
// AUTH
// -------------------------
const clientId = "130";
const redirectUri = "https://dao-active-injunctions.onrender.com/auth/callback";
document.getElementById('loginBtn').addEventListener('click', () => {
  window.location.href = `https://ucp.gta.world/oauth/authorize?client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&response_type=code`;
});

// Parse URL
const params = new URLSearchParams(window.location.search);
const username = params.get('username');
if(username) {
  document.getElementById('loginBtn').style.display='none';
  document.getElementById('createZoneBtn').style.display='block';
}

// -------------------------
// LOAD ZONES
// -------------------------
let zones = [];
function loadZones() {
  fetch('/zones').then(r=>r.json()).then(data=>{
    zones = data;
    zones.forEach(zone => {
      if(!zone.layer) {
        zone.layer = L.polygon(zone.points, {color: zone.color, fillOpacity:0.4}).addTo(map)
          .on('click', ()=>showInfoSidebar(zone));
      } else {
        zone.layer.setLatLngs(zone.points).setStyle({color: zone.color});
      }
    });
  });
}
loadZones();

// -------------------------
// CREATE ZONE
// -------------------------
const createBtn = document.getElementById('createZoneBtn');
createBtn.addEventListener('click', ()=>{
  if(!daoAuthorized) {
    const pw = prompt("Enter DAO password to create zone:");
    if(pw !== "daopassword2026") return alert("Incorrect password");
    daoAuthorized=true;
  }
  drawingZone=true; tempPoints=[]; if(tempPolygon) map.removeLayer(tempPolygon);
  alert("Click points on map to create zone. Edit in the sidebar and press Save.");
  document.getElementById('editSidebar').classList.add('active');
});

// Map click for drawing
map.on('click', e=>{
  if(drawingZone) {
    tempPoints.push([e.latlng.lat,e.latlng.lng]);
    if(tempPolygon) map.removeLayer(tempPolygon);
    tempPolygon = L.polygon(tempPoints,{color:"#0000FF",fillOpacity:0.4}).addTo(map);
  }
});

// -------------------------
// SIDE BAR ELEMENTS
// -------------------------
const editSidebar = document.getElementById('editSidebar');
const infoSidebar = document.getElementById('infoSidebar');
document.getElementById('editClose').onclick = ()=>editSidebar.classList.remove('active');
document.getElementById('infoClose').onclick = ()=>infoSidebar.classList.remove('active');

document.getElementById('saveZoneBtn').onclick = ()=>{
  if(tempPoints.length===0 && !selectedZone) return alert("No points defined");
  const name = document.getElementById('zoneName').value;
  const color = document.getElementById('zoneColor').value;
  const info = document.getElementById('zoneInfo').value;
  const mugshots = document.getElementById('zoneMugshots').value.split("\n").filter(x=>x);

  const id = selectedZone ? selectedZone.id : null;

  fetch('/zones',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      name, points: selectedZone ? selectedZone.points : tempPoints,
      color, info, mugshots, password:"daopassword2026", creator:username, id
    })
  }).then(r=>r.json()).then(zone=>{
    if(selectedZone) {
      selectedZone.layer.setLatLngs(zone.points).setStyle({color: zone.color});
      Object.assign(selectedZone, zone);
    } else {
      zone.layer = L.polygon(zone.points, {color: zone.color, fillOpacity:0.4}).addTo(map)
        .on('click', ()=>showInfoSidebar(zone));
      zones.push(zone);
    }
    tempPoints=[]; tempPolygon=null; drawingZone=false; selectedZone=null;
    editSidebar.classList.remove('active');
  }).catch(e=>alert("Error saving zone"));
};

// Delete zone
document.getElementById('deleteZoneBtn').onclick = ()=>{
  if(!selectedZone) return;
  if(!confirm("Delete this zone?")) return;
  fetch(`/zones/${selectedZone.id}`,{
    method:'DELETE',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({password:"daopassword2026"})
  }).then(r=>r.json()).then(()=>{
    map.removeLayer(selectedZone.layer);
    zones = zones.filter(z=>z.id!==selectedZone.id);
    selectedZone=null; editSidebar.classList.remove('active');
  }).catch(()=>alert("Error deleting zone"));
};

// -------------------------
// SHOW INFO SIDEBAR
// -------------------------
function showInfoSidebar(zone){
  selectedZone=zone;
  document.getElementById('infoName').innerText = zone.name;
  document.getElementById('infoText').innerText = zone.info + "\nCreated by: " + zone.creator;
  const mugDiv = document.getElementById('infoMugshots');
  mugDiv.innerHTML = "";
  zone.mugshots.forEach(m=>{
    let [url,label] = m.split(":");
    const img = document.createElement('img');
    img.src=url.trim(); img.width=150; img.height=150;
    const caption = document.createElement('div');
    caption.innerText = label || "";
    caption.style.textAlign="center"; caption.style.marginBottom="10px";
    mugDiv.appendChild(img); mugDiv.appendChild(caption);
  });
  infoSidebar.classList.add('active');

  // Populate edit sidebar if DAO authorized
  if(daoAuthorized){
    document.getElementById('zoneName').value=zone.name;
    document.getElementById('zoneColor').value=zone.color;
    document.getElementById('zoneInfo').value=zone.info;
    document.getElementById('zoneMugshots').value=zone.mugshots.join("\n");
    editSidebar.classList.add('active');
  }
}
</script>

</body>
</html>
